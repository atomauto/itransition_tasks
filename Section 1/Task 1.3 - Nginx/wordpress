#shellcheck disable=all
log_format  main  '$http_x_forwarded_for - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" $http_host';
server {
        listen 8080 default_server;
        listen [::]:8080 default_server;
        # SSL configuration
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        # include snippets/snakeoil.conf;
        root /var/www/wordpress;
        index index.php index.html index.htm index.nginx-debian.html;
        server_name _;
        access_log /var/log/nginx/wordpress-backend.access.log main;
    	error_log /var/log/nginx/wordpress-backend.error.log;

        location / {
                try_files $uri $uri/ /index.php?$args; # permalinks
        }
        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
        # php-fpm.sock in debian is alias to php7.4-fpm
        # default config is shit that breaks everything if php major version is updated
                fastcgi_pass unix:/run/php/php-fpm.sock;
        }

}

#As a reverse proxy, static files will be served and cached by this block
#Let's just suggest, that backend is slow java app )

server {
        listen 80;
        listen [::]:80;
        server_name wordpress.spam;
        root /var/www/wordpress;
        # index index.html;
        location / {
                proxy_pass http://localhost:8080/;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        location ~ /\. {
                deny all; # запрет для скрытых файлов
        }
        location ~* /(?:uploads|files)/.*\.php$ {
                deny all; # запрет для загруженных скриптов
        }
        location ~ /\.ht {
                deny all;
        }
        location = /favicon.ico {
                log_not_found off;
                access_log off;
        }
        location = /robots.txt {
                allow all;
                log_not_found off;
                access_log off;
        }
        location ~* ^.+\.(js|css|ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
                access_log off;
                log_not_found off;
                expires max;
        }
}
